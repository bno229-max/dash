<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Intelligence Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0b0f1a; color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        
        .glass-card { 
            background: rgba(30, 41, 59, 0.5); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.08); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .glass-card:hover { 
            transform: translateY(-5px); 
            border-color: rgba(59, 130, 246, 0.5); 
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.2); 
        }
        
        .input-field { 
            background: #1e293b; 
            border: 1px solid #334155; 
            border-radius: 8px; 
            padding: 10px; 
            color: white; 
            width: 100%; 
            outline: none; 
            transition: all 0.2s; 
        }
        .input-field:focus { 
            border-color: #3b82f6; 
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.3); 
        }
        
        label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
        
        .text-ifood { color: #ef4444; text-shadow: 0 0 12px rgba(239, 68, 68, 0.4); } 
        .text-keeta { color: #facc15; text-shadow: 0 0 12px rgba(250, 204, 21, 0.4); } 
        .text-loja { color: #ffffff; text-shadow: 0 0 12px rgba(255, 255, 255, 0.4); }
        
        .hidden { display: none; }
        .btn-glow { transition: 0.3s; }
        .btn-glow:hover { box-shadow: 0 0 20px rgba(37, 99, 235, 0.6); transform: scale(1.02); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="authContainer" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0b0f1a] px-4">
        <div class="glass-card p-8 rounded-3xl w-full max-w-md border-t-4 border-blue-500 shadow-[0_0_60px_rgba(0,0,0,0.6)]">
            <div class="text-center mb-8">
                <h1 id="authTitle" class="text-2xl font-bold tracking-tight">Acesso Premium</h1>
                <p id="authSubtitle" class="text-slate-400 text-sm mt-2">Inteligência de Vendas em Nuvem</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label>E-mail de Usuário</label>
                    <input type="email" id="authEmail" class="input-field" placeholder="seu@email.com">
                </div>
                <div>
                    <label>Senha</label>
                    <input type="password" id="authPass" class="input-field" placeholder="••••••••">
                </div>
                
                <button id="btnAuth" class="btn-glow w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl mt-4 transition-all">
                    Entrar no Dashboard
                </button>

                <div class="pt-4 space-y-3">
                    <p class="text-center text-sm text-slate-400">
                        <span id="toggleText">Não possui conta?</span>
                        <button id="btnToggleAuth" class="text-blue-400 font-bold ml-1 hover:underline">Criar agora</button>
                    </p>
                    <p class="text-center">
                        <button id="btnForgot" class="text-xs text-slate-500 hover:text-white transition underline">Esqueci minha senha</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="mainDashboard" class="max-w-6xl mx-auto hidden">
        <header class="mb-10 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-extrabold tracking-tight">Dashboard de Performance</h1>
                <p class="text-slate-400">Análise dinâmica de canais de venda</p>
            </div>
            <button id="btnLogout" class="text-[10px] font-bold text-slate-500 hover:text-red-400 uppercase tracking-widest border border-slate-800 px-4 py-2 rounded-lg transition-all">Sair</button>
        </header>

        <section class="glass-card p-6 rounded-2xl mb-8 border-t-4 border-blue-500">
            <h2 class="text-sm font-bold mb-6 text-blue-400 flex items-center gap-2">
                <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span> LANÇAMENTO DE RESULTADOS
            </h2>
            
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div><label>Mês</label>
                    <select id="selectMes" class="input-field">
                        <option value="01">Janeiro</option><option value="02">Fevereiro</option><option value="03">Março</option>
                        <option value="04">Abril</option><option value="05">Maio</option><option value="06">Junho</option>
                        <option value="07">Julho</option><option value="08">Agosto</option><option value="09">Setembro</option>
                        <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                </div>
                <div><label>Ano</label>
                    <select id="selectAno" class="input-field">
                        <option value="2024">2024</option><option value="2025" selected>2025</option><option value="2026">2026</option>
                    </select>
                </div>
                <div><label>iFood (R$)</label><input type="number" id="valIfood" placeholder="0,00" class="input-field"></div>
                <div><label>Keeta (R$)</label><input type="number" id="valKeeta" placeholder="0,00" class="input-field"></div>
                <div><label>Loja Física (R$)</label><input type="number" id="valLoja" placeholder="0,00" class="input-field"></div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="btnSalvar" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg transition-all flex-1 md:flex-none btn-glow">Salvar Registro</button>
                <button id="btnLimpar" class="text-slate-500 hover:text-red-400 text-sm font-semibold px-4 underline">Limpar Histórico</button>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card p-6 rounded-2xl">
                <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Faturamento Mês Atual</span>
                <div id="totalGeral" class="text-3xl font-bold mt-1 text-white">R$ 0,00</div>
            </div>
            <div class="glass-card p-6 rounded-2xl border-b-4 border-slate-700">
                <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Canal com Maior Venda</span>
                <div id="bestChannel" class="text-2xl font-bold mt-1 transition-colors duration-300">-</div>
            </div>
            <div class="glass-card p-6 rounded-2xl">
                <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Crescimento Mês vs Anterior</span>
                <div id="crescimentoPorcentagem" class="text-3xl font-bold mt-1 text-slate-500">--</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="glass-card p-6 rounded-2xl lg:col-span-2">
                <h3 class="text-sm font-bold mb-6 text-slate-300 uppercase tracking-widest">Desempenho</h3>
                <canvas id="lineChart" height="150"></canvas>
            </div>
            <div class="glass-card p-6 rounded-2xl">
                <h3 class="text-sm font-bold mb-6 text-slate-300 uppercase tracking-widest">SHARE POR CANAL</h3>
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDocs, collection, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBe16h9VH99V2cF-pJQVo5SJPha6uWsWJ0",
            authDomain: "dash-4c84d.firebaseapp.com",
            projectId: "dash-4c84d",
            storageBucket: "dash-4c84d.firebasestorage.app",
            messagingSenderId: "183916342443",
            appId: "1:183916342443:web:df4b375cc1978144f91bee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let dadosVendas = [];
        let charts = {};
        let isLoginMode = true;

        // AUTH
        const btnToggleAuth = document.getElementById('btnToggleAuth');
        btnToggleAuth.onclick = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? "Acesso Premium" : "Criar Nova Conta";
            document.getElementById('btnAuth').innerText = isLoginMode ? "Entrar no Dashboard" : "Finalizar Cadastro";
            document.getElementById('toggleText').innerText = isLoginMode ? "Não possui conta?" : "Já possui conta?";
            btnToggleAuth.innerText = isLoginMode ? "Criar agora" : "Fazer Login";
        };

        document.getElementById('btnAuth').onclick = async () => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            if(!email || !pass) return alert("Por favor, preencha e-mail e senha.");
            try {
                if(isLoginMode) await signInWithEmailAndPassword(auth, email, pass);
                else await createUserWithEmailAndPassword(auth, email, pass);
            } catch (e) { alert("Erro: " + e.message); }
        };

        document.getElementById('btnForgot').onclick = async () => {
            const email = document.getElementById('authEmail').value;
            if(!email) return alert("Digite seu e-mail no campo acima para receber o link de recuperação.");
            try {
                await sendPasswordResetEmail(auth, email);
                alert("E-mail de recuperação enviado!");
            } catch (e) { alert("Erro: " + e.message); }
        };

        document.getElementById('btnLogout').onclick = () => signOut(auth);

        // DASHBOARD
        function inicializarGraficos() {
            if(charts.line) charts.line.destroy();
            if(charts.pie) charts.pie.destroy();

            const ctxL = document.getElementById('lineChart').getContext('2d');
            const ctxP = document.getElementById('pieChart').getContext('2d');

            charts.line = new Chart(ctxL, {
                type: 'line',
                data: { labels: [], datasets: [
                    { label: 'iFood', borderColor: '#ef4444', data: [], tension: 0.4, borderWidth: 3 },
                    { label: 'Keeta', borderColor: '#facc15', data: [], tension: 0.4, borderWidth: 3 },
                    { label: 'Loja Física', borderColor: '#ffffff', data: [], tension: 0.4, borderWidth: 3 }
                ]},
                options: { responsive: true, plugins: { legend: { labels: { color: '#94a3b8' } } }, scales: { y: { grid: { color: '#1e293b' }, ticks: { color: '#64748b' } }, x: { grid: { display: false }, ticks: { color: '#64748b' } } } }
            });

            charts.pie = new Chart(ctxP, {
                type: 'doughnut',
                data: { labels: ['iFood', 'Keeta', 'Loja'], datasets: [{ data: [0,0,0], backgroundColor: ['#ef4444', '#facc15', '#ffffff'], borderWidth: 0 }] },
                options: { cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } }, tooltip: { callbacks: { label: (ctx) => {
                    let total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    return `${ctx.label}: ${((ctx.parsed/total)*100).toFixed(1)}%`;
                }}}}}
            });
        }

        document.getElementById('btnSalvar').onclick = async () => {
            const user = auth.currentUser;
            const mes = document.getElementById('selectMes').value;
            const ano = document.getElementById('selectAno').value;
            const valI = parseFloat(document.getElementById('valIfood').value) || 0;
            const valK = parseFloat(document.getElementById('valKeeta').value) || 0;
            const valL = parseFloat(document.getElementById('valLoja').value) || 0;
            const periodoKey = `${ano}-${mes}`;

            await setDoc(doc(db, "usuarios", user.uid, "vendas", periodoKey), {
                key: periodoKey,
                label: `${document.getElementById('selectMes').options[document.getElementById('selectMes').selectedIndex].text}/${ano}`,
                ifood: valI, keeta: valK, loja: valL
            });
            carregarDados();
        };

        async function carregarDados() {
            const user = auth.currentUser;
            const q = query(collection(db, "usuarios", user.uid, "vendas"), orderBy("key"));
            const snapshot = await getDocs(q);
            dadosVendas = snapshot.docs.map(doc => doc.data());
            atualizarInterface();
        }

        function atualizarInterface() {
            if (dadosVendas.length === 0) return;
            charts.line.data.labels = dadosVendas.map(d => d.label);
            charts.line.data.datasets[0].data = dadosVendas.map(d => d.ifood);
            charts.line.data.datasets[1].data = dadosVendas.map(d => d.keeta);
            charts.line.data.datasets[2].data = dadosVendas.map(d => d.loja);
            charts.line.update();

            const ultimo = dadosVendas[dadosVendas.length - 1];
            const total = ultimo.ifood + ultimo.keeta + ultimo.loja;
            document.getElementById('totalGeral').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

            const canais = { 'iFood': ultimo.ifood, 'Keeta': ultimo.keeta, 'Loja Física': ultimo.loja };
            const vencedor = Object.keys(canais).reduce((a, b) => canais[a] > canais[b] ? a : b);
            const bestEl = document.getElementById('bestChannel');
            bestEl.innerText = total > 0 ? vencedor : "-";
            bestEl.classList.remove('text-ifood', 'text-keeta', 'text-loja');
            if(total > 0) {
                if(vencedor === 'iFood') bestEl.classList.add('text-ifood');
                else if(vencedor === 'Keeta') bestEl.classList.add('text-keeta');
                else bestEl.classList.add('text-loja');
            }

            const crescEl = document.getElementById('crescimentoPorcentagem');
            if(dadosVendas.length >= 2) {
                const anterior = dadosVendas[dadosVendas.length - 2];
                const somaAnt = anterior.ifood + anterior.keeta + anterior.loja;
                const perc = somaAnt > 0 ? ((total - somaAnt) / somaAnt) * 100 : 0;
                crescEl.innerText = `${perc > 0 ? '↑' : '↓'} ${Math.abs(perc).toFixed(1)}%`;
                crescEl.className = `text-3xl font-bold mt-1 ${perc >= 0 ? 'text-emerald-400' : 'text-red-400'}`;
            }
            charts.pie.data.datasets[0].data = [ultimo.ifood, ultimo.keeta, ultimo.loja];
            charts.pie.update();
        }

        document.getElementById('btnLimpar').onclick = async () => {
            if(confirm("Apagar todos os dados da nuvem?")) {
                const user = auth.currentUser;
                const q = query(collection(db, "usuarios", user.uid, "vendas"));
                const snapshot = await getDocs(q);
                const promises = snapshot.docs.map(d => deleteDoc(d.ref));
                await Promise.all(promises);
                location.reload();
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authContainer').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                inicializarGraficos();
                carregarDados();
            } else {
                document.getElementById('authContainer').classList.remove('hidden');
                document.getElementById('mainDashboard').classList.add('hidden');
            }
        });
    </script>
</body>
</html>